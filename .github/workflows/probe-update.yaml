name: Update certsuite-probe version references

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  update-probe:
    if: github.repository_owner == 'redhat-best-practices-for-k8s'
    name: Update probe image tag and open PR
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      pull-requests: write
    env:
      SHELL: /bin/bash
      PROBE_REPO: redhat-best-practices-for-k8s/certsuite-probe
      PROBE_RELEASES_URL: https://api.github.com/repos/redhat-best-practices-for-k8s/certsuite-probe/releases/latest
    steps:
      - name: Check out code
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          ref: main

      - name: Set up Go
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version-file: go.mod

      - name: Determine current and latest probe versions
        id: versions
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          CURRENT=$(jq -r '.debugTag' version.json)
          echo "current=${CURRENT}" >> $GITHUB_OUTPUT

          # Fetch latest release tag using GitHub CLI with retry and exponential backoff
          if ! command -v gh >/dev/null 2>&1; then
            echo "GitHub CLI (gh) not found on PATH" >&2
            exit 1
          fi

          LATEST=""
          for attempt in {1..5}; do
            set +e
            LATEST=$(gh release list -R redhat-best-practices-for-k8s/certsuite-probe --limit 1 --json tagName,isLatest --jq '.[] | select(.isLatest) | .tagName')
            rc=$?
            set -e

            if [[ ${rc} -eq 0 && -n "${LATEST}" ]]; then
              break
            fi

            SLEEP=$((2 ** (attempt-1)))
            echo "Attempt ${attempt} failed (rc=${rc}). Retrying in ${SLEEP}s..."
            sleep "${SLEEP}"
          done

          if [[ -z "${LATEST}" || "${LATEST}" == "null" ]]; then
            echo "Failed to resolve latest probe tag after retries" >&2
            exit 1
          fi
          echo "latest=${LATEST}" >> $GITHUB_OUTPUT

          if [[ "${CURRENT}" == "${LATEST}" ]]; then
            echo "Probe already at latest (${LATEST})."; echo "should_update=false" >> $GITHUB_OUTPUT
          else
            echo "should_update=true" >> $GITHUB_OUTPUT
          fi

      - name: Stop if already up to date
        if: steps.versions.outputs.should_update == 'false'
        run: echo "No update needed"

      - name: Update files to latest probe version
        if: steps.versions.outputs.should_update == 'true'
        run: |
          set -euo pipefail
          LATEST=${{ steps.versions.outputs.latest }}

          # Update version.json (debugTag)
          tmp=$(mktemp)
          jq --arg tag "${LATEST}" '.debugTag = $tag' version.json > "$tmp" && mv "$tmp" version.json

          # Update docs/runtime-env.md default image reference
          sed -i "s|certsuite-probe:v[0-9]\+\.[0-9]\+\.[0-9]\+|certsuite-probe:${LATEST}|" docs/runtime-env.md

          # Update default flag in cmd/certsuite/run/run.go
          sed -i "s|quay.io/redhat-best-practices-for-k8s/certsuite-probe:v[0-9]\+\.[0-9]\+\.[0-9]\+|quay.io/redhat-best-practices-for-k8s/certsuite-probe:${LATEST}|" cmd/certsuite/run/run.go

          echo "Updated files to ${LATEST}:"
          git --no-pager diff -- . | cat

      - name: Run unit tests
        if: steps.versions.outputs.should_update == 'true'
        run: make test

      - name: Create PR
        if: steps.versions.outputs.should_update == 'true'
        uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e # v7.0.8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update certsuite-probe to ${{ steps.versions.outputs.latest }}"
          title: "Update probe to ${{ steps.versions.outputs.latest }}"
          body: |
            - Bump certsuite-probe to `${{ steps.versions.outputs.latest }}`
            - Updated `version.json`, `docs/runtime-env.md`, and `cmd/certsuite/run/run.go`
          branch: update-probe-${{ steps.versions.outputs.latest }}


