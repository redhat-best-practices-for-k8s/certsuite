name: setup-partner-cluster
description: 'Setup a partner cluster for testing.'

inputs:
  make-command:
    description: 'The make command to run.'
    required: true
  num-worker-nodes:
    description: 'Number of worker nodes for the cluster.'
    required: false
    default: '2'

runs:
  using: 'composite'
  steps:
    - name: Check out `certsuite-sample-workload`
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      with:
        repository: redhat-best-practices-for-k8s/certsuite-sample-workload
        path: certsuite-sample-workload

    - name: Setup quick-k8s cluster
      uses: palmsoftware/quick-k8s@v0.0.48
      with:
        disableDefaultCni: true
        numControlPlaneNodes: 1
        numWorkerNodes: ${{ inputs.num-worker-nodes }}
        installOLM: true
        removeDefaultStorageClass: true
        removeControlPlaneTaint: true

    - name: Run 'make ${{inputs.make-command}}'
      uses: nick-fields/retry@ce71cc2ab81d554ebbe88c79ab5975992d79ba08 # v3.0.2
      with:
        timeout_minutes: 150
        max_attempts: 3
        command: cd ${GITHUB_WORKSPACE}/certsuite-sample-workload; python3 -m venv .venv; source .venv/bin/activate; pip install --upgrade pip; pip install jinjanator; cp .venv/bin/jinjanate .venv/bin/j2; make ${{ inputs.make-command }}

    - name: Show pods
      shell: bash
      run: oc get pods -A
