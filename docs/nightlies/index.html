<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certsuite Workflow Dashboard</title>
    <style>
        :root {
            --success: #22c55e;
            --failure: #ef4444;
            --pending: #f59e0b;
            --neutral: #6b7280;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            color: #0f172a;
        }

        .header p {
            color: var(--neutral);
            font-size: 1.1rem;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .card h3 {
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--neutral);
            margin-bottom: 0.5rem;
        }

        .card .value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .card.success .value { color: var(--success); }
        .card.failure .value { color: var(--failure); }
        .card.pending .value { color: var(--pending); }

        .workflows-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(550px, 1fr));
            gap: 1.5rem;
        }

        @media (max-width: 1200px) {
            .workflows-grid {
                grid-template-columns: 1fr;
            }
        }

        .workflow-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }

        .workflow-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .workflow-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .workflow-title-link {
            text-decoration: none;
            color: inherit;
        }

        .workflow-title-link:hover .workflow-title {
            color: #3b82f6;
            text-decoration: underline;
        }

        .workflow-subtitle {
            color: var(--neutral);
            font-size: 0.875rem;
        }

        .runs-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .run-item {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f1f5f9;
        }

        .run-item:last-child {
            border-bottom: none;
        }

        .status-badge {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 1rem;
            flex-shrink: 0;
        }

        .status-badge.success { background: var(--success); }
        .status-badge.failure { background: var(--failure); }
        .status-badge.pending { background: var(--pending); }

        .run-info {
            flex-grow: 1;
        }

        .run-id {
            font-weight: 500;
            color: #3b82f6;
            text-decoration: none;
            font-size: 0.875rem;
        }

        .run-id:hover {
            text-decoration: underline;
        }

        .run-time {
            color: var(--neutral);
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--neutral);
        }

        .error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .refresh-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            margin-top: 1rem;
        }

        .refresh-btn:hover {
            background: #2563eb;
        }

        .last-updated {
            text-align: center;
            color: var(--neutral);
            font-size: 0.875rem;
            margin-top: 2rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Certsuite Workflow Dashboard</h1>
            <p>Monitoring the last 3 days of workflow results</p>
            <button class="refresh-btn" onclick="refreshData()">üîÑ Refresh Data</button>
        </div>

        <div id="summary" class="summary-cards">
            <!-- Summary cards will be populated by JavaScript -->
        </div>

        <div id="error" style="display: none;" class="error">
            <strong>Error:</strong> <span id="error-message"></span>
        </div>

        <div id="loading" class="loading">
            <p>Loading workflow data...</p>
        </div>

        <div id="workflows" class="workflows-grid" style="display: none;">
            <!-- Workflow cards will be populated by JavaScript -->
        </div>

        <div id="last-updated" class="last-updated">
            <!-- Last updated time will be shown here -->
        </div>
    </div>

    <script>
        // Configuration
        const REPO_OWNER = 'redhat-best-practices-for-k8s';
        const REPO_NAME = 'certsuite';
        const DAYS_BACK = 3;
        
        // Workflows to monitor (from the rekick script)
        const WORKFLOWS_TO_MONITOR = [
            "QE OCP 4.14 Testing",
            "QE OCP 4.15 Testing", 
            "QE OCP 4.16 Testing",
            "QE OCP 4.17 Testing",
            "QE OCP 4.18 Testing",
            "QE OCP 4.19 Testing",
            "QE OCP 4.14 Intrusive Testing",
            "QE OCP 4.15 Intrusive Testing",
            "QE OCP 4.16 Intrusive Testing", 
            "QE OCP 4.17 Intrusive Testing",
            "QE OCP 4.18 Intrusive Testing",
            "QE OCP 4.19 Intrusive Testing",
            "qe-ocp-hosted.yml"
        ];

        // Calculate cutoff date (3 days ago)
        const cutoffDate = new Date();
        cutoffDate.setDate(cutoffDate.getDate() - DAYS_BACK);

        // GitHub API base URL
        const API_BASE = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}`;

        async function fetchWorkflowRuns(workflowName) {
            try {
                // Note: In a real implementation, you'd want to handle pagination and rate limits
                const response = await fetch(`${API_BASE}/actions/workflows`);
                const workflows = await response.json();
                
                // Find the workflow by name
                const workflow = workflows.workflows.find(w => 
                    w.name === workflowName || w.path.includes(workflowName)
                );
                
                if (!workflow) {
                    return { workflow: workflowName, runs: [] };
                }

                // Fetch recent runs for this workflow
                const runsResponse = await fetch(`${API_BASE}/actions/workflows/${workflow.id}/runs?per_page=20`);
                const runsData = await runsResponse.json();
                
                // Filter runs from last 3 days
                const recentRuns = runsData.workflow_runs.filter(run => 
                    new Date(run.created_at) >= cutoffDate
                );

                return { 
                    workflow: workflowName, 
                    runs: recentRuns,
                    id: workflow.id 
                };
            } catch (error) {
                console.error(`Error fetching runs for ${workflowName}:`, error);
                return { workflow: workflowName, runs: [], error: error.message };
            }
        }

        async function loadWorkflowData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('workflows').style.display = 'none';
            document.getElementById('error').style.display = 'none';

            try {
                // Fetch data for all monitored workflows
                const workflowPromises = WORKFLOWS_TO_MONITOR.map(fetchWorkflowRuns);
                const workflowResults = await Promise.all(workflowPromises);
                
                // Generate summary statistics
                generateSummary(workflowResults);
                
                // Generate workflow cards
                generateWorkflowCards(workflowResults);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('workflows').style.display = 'grid';
                
                // Update last refreshed time
                document.getElementById('last-updated').innerHTML = 
                    `Last updated: ${new Date().toLocaleString()}`;
                    
            } catch (error) {
                showError(`Failed to load workflow data: ${error.message}`);
            }
        }

        function generateSummary(workflowResults) {
            let totalRuns = 0;
            let successfulRuns = 0;
            let failedRuns = 0;
            let pendingRuns = 0;
            let totalDurationMs = 0;
            let completedRuns = 0;

            workflowResults.forEach(result => {
                result.runs.forEach(run => {
                    totalRuns++;
                    switch (run.conclusion) {
                        case 'success':
                            successfulRuns++;
                            break;
                        case 'failure':
                        case 'timed_out':
                            failedRuns++;
                            break;
                        default:
                            pendingRuns++;
                    }
                    
                    // Calculate duration for completed runs
                    if (run.conclusion && run.created_at && run.updated_at) {
                        const duration = new Date(run.updated_at) - new Date(run.created_at);
                        totalDurationMs += duration;
                        completedRuns++;
                    }
                });
            });

            const successRate = totalRuns > 0 ? Math.round((successfulRuns / totalRuns) * 100) : 0;
            const avgRuntime = completedRuns > 0 ? formatDuration(totalDurationMs / completedRuns) : '0h';

            document.getElementById('summary').innerHTML = `
                <div class="card success">
                    <h3>Success Rate</h3>
                    <div class="value">${successRate}%</div>
                    <div>${successfulRuns}/${totalRuns} runs</div>
                </div>
                <div class="card failure">
                    <h3>Failed Runs</h3>
                    <div class="value">${failedRuns}</div>
                    <div>Last ${DAYS_BACK} days</div>
                </div>
                <div class="card pending">
                    <h3>Active Workflows</h3>
                    <div class="value">${WORKFLOWS_TO_MONITOR.length}</div>
                    <div>Being monitored</div>
                </div>
                <div class="card">
                    <h3>Avg Runtime</h3>
                    <div class="value">${avgRuntime}</div>
                    <div>Completed runs</div>
                </div>
            `;
        }

        function generateWorkflowCards(workflowResults) {
            const workflowsHtml = workflowResults.map(result => {
                const runsHtml = result.runs.slice(0, 10).map(run => {
                    const statusClass = getStatusClass(run.conclusion);
                    const runUrl = run.html_url;
                    const timeAgo = getTimeAgo(new Date(run.created_at));
                    
                    // Calculate duration
                    let durationText = '';
                    if (run.conclusion && run.created_at && run.updated_at) {
                        const duration = new Date(run.updated_at) - new Date(run.created_at);
                        durationText = ' ‚Ä¢ ' + formatDuration(duration) + ' duration';
                    } else if (!run.conclusion && run.created_at) {
                        // For running jobs, show elapsed time
                        const elapsed = new Date() - new Date(run.created_at);
                        durationText = ' ‚Ä¢ ' + formatDuration(elapsed) + ' elapsed';
                    }
                    
                    return `
                        <div class="run-item">
                            <div class="status-badge ${statusClass}"></div>
                            <div class="run-info">
                                <a href="${runUrl}" class="run-id" target="_blank">
                                    #${run.run_number} - ${run.conclusion || 'running'}
                                </a>
                                <div class="run-time">${timeAgo}${durationText}</div>
                            </div>
                        </div>
                    `;
                }).join('');

                const successCount = result.runs.filter(r => r.conclusion === 'success').length;
                const totalCount = result.runs.length;
                
                // Calculate average runtime for this workflow
                const completedRuns = result.runs.filter(r => r.conclusion && r.created_at && r.updated_at);
                let avgWorkflowRuntime = '';
                if (completedRuns.length > 0) {
                    const totalMs = completedRuns.reduce((sum, run) => {
                        return sum + (new Date(run.updated_at) - new Date(run.created_at));
                    }, 0);
                    avgWorkflowRuntime = ' ‚Ä¢ avg ' + formatDuration(totalMs / completedRuns.length);
                }

                                    // Generate workflow URL
                    const workflowUrl = result.path ? 
                        `https://github.com/${REPO_OWNER}/${REPO_NAME}/actions/workflows/${result.path.split('/').pop()}` : 
                        `https://github.com/${REPO_OWNER}/${REPO_NAME}/actions`;

                    return `
                        <div class="workflow-card">
                            <div class="workflow-header">
                                <div>
                                    <a href="${workflowUrl}" class="workflow-title-link" target="_blank">
                                        <div class="workflow-title">${result.workflow}</div>
                                    </a>
                                    <div class="workflow-subtitle">
                                        ${totalCount} runs in last ${DAYS_BACK} days 
                                        (${successCount} successful)${avgWorkflowRuntime}
                                    </div>
                                </div>
                            </div>
                            <div class="runs-list">
                                ${runsHtml || '<div class="run-item">No recent runs</div>'}
                            </div>
                        </div>
                    `;
            }).join('');

            document.getElementById('workflows').innerHTML = workflowsHtml;
        }

        function getStatusClass(conclusion) {
            switch (conclusion) {
                case 'success': return 'success';
                case 'failure':
                case 'timed_out': return 'failure';
                default: return 'pending';
            }
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffHours / 24);

            if (diffDays > 0) {
                return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            } else if (diffHours > 0) {
                return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            } else {
                const diffMinutes = Math.floor(diffMs / (1000 * 60));
                return `${diffMinutes} minute${diffMinutes > 1 ? 's' : ''} ago`;
            }
        }

        function formatDuration(durationMs) {
            const hours = Math.floor(durationMs / (1000 * 60 * 60));
            const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
            
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else {
                return `${minutes}m`;
            }
        }

        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        function refreshData() {
            loadWorkflowData();
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', loadWorkflowData);
    </script>
</body>
</html> 